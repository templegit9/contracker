<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Engagement Tracker</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Chart.js for visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Include localforage for client-side storage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Link Engagement Tracker</h1>
            <p class="text-gray-600">Track and analyze engagement for individual links across platforms</p>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Link Management Form -->
            <div class="bg-white rounded-lg shadow-md p-6 md:col-span-1">
                <h2 class="text-xl font-semibold mb-4">Add New Link</h2>
                <form id="link-form" class="space-y-4">
                    <div>
                        <label for="link-url" class="block text-sm font-medium text-gray-700">Original Link URL</label>
                        <input type="url" id="link-url" name="link-url" required placeholder="https://example.com/your-content"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="link-name" class="block text-sm font-medium text-gray-700">Link Name/Description</label>
                        <input type="text" id="link-name" name="link-name" required placeholder="Spring 2025 Product Update"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="link-source" class="block text-sm font-medium text-gray-700">Source Platform</label>
                        <select id="link-source" name="link-source" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            <option value="youtube">Youtube</option>
                            <option value="servicenow">ServiceNow Community blog page</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Generate Tracking Link
                    </button>
                </form>
            </div>

            <!-- Your Tracking Links -->
            <div class="bg-white rounded-lg shadow-md p-6 md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Your Tracking Links</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tracking URL</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visits</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="links-list" class="bg-white divide-y divide-gray-200">
                            <!-- Links will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="bg-white rounded-lg shadow-md p-6 md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Engagement Analytics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-medium mb-2">Engagement by Source</h3>
                        <canvas id="source-chart" class="w-full"></canvas>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-2">Top Performing Links</h3>
                        <canvas id="top-links-chart" class="w-full"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="md:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Summary</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Total Links</h3>
                            <p id="total-links" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Total Visits</h3>
                            <p id="total-visits" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-500">Top Source</h3>
                            <p id="top-source" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Engagement Activity -->
            <div class="bg-white rounded-lg shadow-md p-6 md:col-span-3">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Recent Engagement Activity</h2>
                    <div>
                        <button id="export-data" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm mr-2">
                            Export Data
                        </button>
                        <button id="clear-data" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
                            Clear Data
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visitor Info</th>
                            </tr>
                        </thead>
                        <tbody id="activity-list" class="bg-white divide-y divide-gray-200">
                            <!-- Activity entries will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tracking Link Modal -->
    <div id="tracking-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-start">
                <h3 class="text-xl font-semibold" id="modal-title">Your Tracking Link</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="modal-content" class="mt-4">
                <p class="mb-2">Use this link in your content:</p>
                <div class="bg-gray-100 p-3 rounded-md font-mono text-sm break-all mb-4">
                    <span id="tracking-url"></span>
                </div>
                <button id="copy-link" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm w-full">
                    Copy Link
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize localforage
        localforage.config({
            name: 'link-engagement-tracker'
        });

        // Constants
        const SOURCES = {
            youtube: 'Youtube',
            servicenow: 'ServiceNow Community blog page',
            linkedin: 'LinkedIn',
            other: 'Other'
        };

        // Data structures
        let links = []; // Array of link objects
        let visits = []; // Array of visit objects

        // Chart instances
        let sourceChart;
        let topLinksChart;

        // DOM elements
        const linkForm = document.getElementById('link-form');
        const linksList = document.getElementById('links-list');
        const activityList = document.getElementById('activity-list');
        const exportDataBtn = document.getElementById('export-data');
        const clearDataBtn = document.getElementById('clear-data');
        const totalLinksEl = document.getElementById('total-links');
        const totalVisitsEl = document.getElementById('total-visits');
        const topSourceEl = document.getElementById('top-source');
        const trackingModal = document.getElementById('tracking-modal');
        const closeModal = document.getElementById('close-modal');
        const trackingUrl = document.getElementById('tracking-url');
        const copyLinkBtn = document.getElementById('copy-link');

        // Initialize the app
        async function initApp() {
            // Load saved data
            const savedLinks = await localforage.getItem('links');
            if (savedLinks) {
                links = JSON.parse(savedLinks);
            }
            
            const savedVisits = await localforage.getItem('visits');
            if (savedVisits) {
                visits = JSON.parse(savedVisits);
            }
            
            // Check if this is a tracking visit
            const urlParams = new URLSearchParams(window.location.search);
            const linkId = urlParams.get('lid');
            
            if (linkId) {
                // Find the link
                const link = links.find(l => l.id === linkId);
                
                if (link) {
                    // Record the visit
                    const newVisit = {
                        id: Date.now().toString(),
                        linkId: linkId,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || 'Direct/Unknown'
                    };
                    
                    visits.unshift(newVisit);
                    await localforage.setItem('visits', JSON.stringify(visits));
                    
                    // Redirect to the original URL
                    window.location.href = link.originalUrl;
                    return; // Stop execution here as we're redirecting
                }
            }
            
            // Render data
            renderLinks();
            renderActivity();
            updateStats();
            renderCharts();
            
            // Add event listeners
            linkForm.addEventListener('submit', handleFormSubmit);
            exportDataBtn.addEventListener('click', exportData);
            clearDataBtn.addEventListener('click', clearData);
            closeModal.addEventListener('click', () => {
                trackingModal.classList.add('hidden');
            });
            copyLinkBtn.addEventListener('click', copyTrackingLink);
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const originalUrl = document.getElementById('link-url').value;
            const linkName = document.getElementById('link-name').value;
            const source = document.getElementById('link-source').value;
            
            // Generate unique ID for the link
            const linkId = generateId();
            
            // Create tracking URL
            const baseUrl = window.location.href.split('?')[0];
            const trackingLink = `${baseUrl}?lid=${linkId}`;
            
            // Create new link object
            const newLink = {
                id: linkId,
                name: linkName,
                originalUrl: originalUrl,
                trackingUrl: trackingLink,
                source: source,
                createdAt: new Date().toISOString()
            };
            
            // Add to data structure
            links.push(newLink);
            
            // Save to localforage
            await localforage.setItem('links', JSON.stringify(links));
            
            // Update UI
            renderLinks();
            updateStats();
            renderCharts();
            
            // Show the modal with the tracking link
            trackingUrl.textContent = trackingLink;
            trackingModal.classList.remove('hidden');
            
            // Reset form
            linkForm.reset();
        }

        // Render links list
        function renderLinks() {
            linksList.innerHTML = '';
            
            if (links.length === 0) {
                linksList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No tracking links created yet</td></tr>';
                return;
            }
            
            links.forEach(link => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'px-6 py-4 whitespace-nowrap';
                nameCell.textContent = link.name;
                
                const sourceCell = document.createElement('td');
                sourceCell.className = 'px-6 py-4 whitespace-nowrap';
                const sourceSpan = document.createElement('span');
                sourceSpan.textContent = SOURCES[link.source];
                
                // Add color based on source
                if (link.source === 'youtube') {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800';
                } else if (link.source === 'servicenow') {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800';
                } else if (link.source === 'linkedin') {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800';
                } else {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800';
                }
                
                sourceCell.appendChild(sourceSpan);
                
                const urlCell = document.createElement('td');
                urlCell.className = 'px-6 py-4 text-sm text-gray-500';
                
                // Create a truncated version of the tracking URL
                const urlText = document.createElement('span');
                urlText.className = 'font-mono text-xs';
                urlText.textContent = truncateText(link.trackingUrl, 30);
                urlText.title = link.trackingUrl;
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'ml-2 text-blue-600 hover:text-blue-900 text-xs';
                copyBtn.textContent = 'Copy';
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(link.trackingUrl);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy';
                    }, 2000);
                });
                
                urlCell.appendChild(urlText);
                urlCell.appendChild(copyBtn);
                
                const visitsCell = document.createElement('td');
                visitsCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                const visitCount = visits.filter(v => v.linkId === link.id).length;
                visitsCell.textContent = visitCount;
                
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-600 hover:text-red-900';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteLink(link.id));
                
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(nameCell);
                row.appendChild(sourceCell);
                row.appendChild(urlCell);
                row.appendChild(visitsCell);
                row.appendChild(actionsCell);
                
                linksList.appendChild(row);
            });
        }

        // Render activity list
        function renderActivity() {
            activityList.innerHTML = '';
            
            if (visits.length === 0) {
                activityList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No engagement activity recorded yet</td></tr>';
                return;
            }
            
            // Show only the most recent 50 visits
            visits.slice(0, 50).forEach(visit => {
                const link = links.find(l => l.id === visit.linkId);
                if (!link) return; // Skip if link was deleted
                
                const row = document.createElement('tr');
                
                const timestampCell = document.createElement('td');
                timestampCell.className = 'px-6 py-4 whitespace-nowrap';
                timestampCell.textContent = formatDate(visit.timestamp);
                
                const nameCell = document.createElement('td');
                nameCell.className = 'px-6 py-4 whitespace-nowrap';
                nameCell.textContent = link.name;
                
                const sourceCell = document.createElement('td');
                sourceCell.className = 'px-6 py-4 whitespace-nowrap';
                const sourceSpan = document.createElement('span');
                sourceSpan.textContent = SOURCES[link.source];
                
                // Add color based on source
                if (link.source === 'youtube') {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800';
                } else if (link.source === 'servicenow') {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800';
                } else if (link.source === 'linkedin') {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800';
                } else {
                    sourceSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800';
                }
                
                sourceCell.appendChild(sourceSpan);
                
                const infoCell = document.createElement('td');
                infoCell.className = 'px-6 py-4 text-sm text-gray-500';
                infoCell.title = `Full User Agent: ${visit.userAgent}\nReferrer: ${visit.referrer}`;
                
                // Extract browser info
                const browserInfo = getBrowserInfo(visit.userAgent);
                infoCell.textContent = browserInfo;
                
                row.appendChild(timestampCell);
                row.appendChild(nameCell);
                row.appendChild(sourceCell);
                row.appendChild(infoCell);
                
                activityList.appendChild(row);
            });
        }

        // Update statistics
        function updateStats() {
            // Total links
            totalLinksEl.textContent = links.length;
            
            // Total visits
            totalVisitsEl.textContent = visits.length;
            
            // Top source
            const sourceCounts = {};
            links.forEach(link => {
                const linkVisits = visits.filter(v => v.linkId === link.id).length;
                sourceCounts[link.source] = (sourceCounts[link.source] || 0) + linkVisits;
            });
            
            const topSource = Object.keys(sourceCounts).reduce((a, b) => 
                (sourceCounts[a] > sourceCounts[b] ? a : b), null);
            
            if (topSource && sourceCounts[topSource] > 0) {
                topSourceEl.textContent = SOURCES[topSource];
            } else {
                topSourceEl.textContent = '-';
            }
        }

        // Render charts
        function renderCharts() {
            // Prepare data for source chart
            const sourceData = {};
            links.forEach(link => {
                const linkVisits = visits.filter(v => v.linkId === link.id).length;
                sourceData[link.source] = (sourceData[link.source] || 0) + linkVisits;
            });
            
            // Prepare data for top links chart
            const linkData = {};
            links.forEach(link => {
                const linkVisits = visits.filter(v => v.linkId === link.id).length;
                if (linkVisits > 0) {
                    linkData[link.name] = linkVisits;
                }
            });
            
            // Sort and take top 5 links
            const topLinks = Object.entries(linkData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // Create or update source chart
            const sourceCtx = document.getElementById('source-chart').getContext('2d');
            if (sourceChart) {
                sourceChart.destroy();
            }
            
            sourceChart = new Chart(sourceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sourceData).map(source => SOURCES[source]),
                    datasets: [{
                        data: Object.values(sourceData),
                        backgroundColor: [
                            '#FF0000', // red for Youtube
                            '#339933', // green for ServiceNow 
                            '#0A66C2', // blue for LinkedIn
                            '#9CA3AF'  // gray for Others
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Create or update top links chart
            const topLinksCtx = document.getElementById('top-links-chart').getContext('2d');
            if (topLinksChart) {
                topLinksChart.destroy();
            }
            
            topLinksChart = new Chart(topLinksCtx, {
                type: 'bar',
                data: {
                    labels: topLinks.map(item => truncateText(item[0], 15)),
                    datasets: [{
                        label: 'Visits',
                        data: topLinks.map(item => item[1]),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Delete link
        async function deleteLink(id) {
            if (confirm('Are you sure you want to delete this tracking link? This will also remove all associated visit data.')) {
                // Remove the link
                links = links.filter(link => link.id !== id);
                
                // Remove associated visits
                visits = visits.filter(visit => visit.linkId !== id);
                
                // Save to localforage
                await localforage.setItem('links', JSON.stringify(links));
                await localforage.setItem('visits', JSON.stringify(visits));
                
                // Update UI
                renderLinks();
                renderActivity();
                updateStats();
                renderCharts();
            }
        }

        // Export data as CSV
        function exportData() {
            if (links.length === 0 && visits.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create links CSV
            const linksHeaders = ['ID', 'Name', 'Original URL', 'Tracking URL', 'Source', 'Created At'];
            const linksData = links.map(link => [
                link.id,
                link.name,
                link.originalUrl,
                link.trackingUrl,
                SOURCES[link.source],
                link.createdAt
            ]);
            linksData.unshift(linksHeaders);
            const linksCSV = linksData.map(row => row.join(',')).join('\n');
            
            // Create visits CSV
            const visitsHeaders = ['ID', 'Link ID', 'Link Name', 'Source', 'Timestamp', 'User Agent', 'Referrer'];
            const visitsData = visits.map(visit => {
                const link = links.find(l => l.id === visit.linkId);
                return [
                    visit.id,
                    visit.linkId,
                    link ? link.name : 'Unknown Link',
                    link ? SOURCES[link.source] : 'Unknown',
                    visit.timestamp,
                    `"${visit.userAgent.replace(/"/g, '""')}"`,
                    `"${visit.referrer.replace(/"/g, '""')}"`
                ];
            });
            visitsData.unshift(visitsHeaders);
            const visitsCSV = visitsData.map(row => row.join(',')).join('\n');
            
            // Create combined data object
            const exportData = {
                links: linksCSV,
                visits: visitsCSV,
                exportDate: new Date().toISOString()
            };
            
            // Create download link for JSON export
            const jsonBlob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            const jsonLink = document.createElement('a');
            jsonLink.setAttribute('href', jsonUrl);
            jsonLink.setAttribute('download', `engagement-data-${new Date().toISOString().slice(0, 10)}.json`);
            jsonLink.style.visibility = 'hidden';
            document.body.appendChild(jsonLink);
            jsonLink.click();
            document.body.removeChild(jsonLink);
        }

        // Clear all data
        async function clearData() {
            if (confirm('Are you sure you want to clear all tracking links and engagement data? This cannot be undone.')) {
                links = [];
                visits = [];
                await localforage.setItem('links', JSON.stringify(links));
                await localforage.setItem('visits', JSON.stringify(visits));
                renderLinks();
                renderActivity();
                updateStats();
                renderCharts();
            }
        }

        // Copy tracking link
        function copyTrackingLink() {
            const linkText = trackingUrl.textContent;
            navigator.clipboard.writeText(linkText);
            copyLinkBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyLinkBtn.textContent = 'Copy Link';
            }, 2000);
        }

        // Helper functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function generateId() {
            return Math.random().toString(36).substring(2, 15) + 
                Math.random().toString(36).substring(2, 15);
        }

        function getBrowserInfo(userAgent) {
            // Simple browser detection
            if (userAgent.includes('Firefox')) {
                return 'Firefox';
            } else if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                return 'Chrome';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                return 'Safari';
            } else if (userAgent.includes('Edg')) {
                return 'Edge';
            } else if (userAgent.includes('MSIE') || userAgent.includes('Trident/')) {
                return 'Internet Explorer';
            } else {
                return 'Unknown Browser';
            }
        }

        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
